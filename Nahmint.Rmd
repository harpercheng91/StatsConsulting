---
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, eval=FALSE}
########## A Demonstration of the Two-Part Model with Nahmint Data #############

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(ggpubr))

Nahmint<- read.csv("Nahmint.all.csv", stringsAsFactors=FALSE)

# Label observations: if density or biomass is 0, label it as 0; otherwise, label as 1.
# This step is a preparation for fitting the logistic regression.
Nahmint <- Nahmint %>% mutate(label=if_else(density.m2==0, 0, 1)) 


######### Two-parts Model ###########

## 1. Part 1: binomial/logistic regression model (on binary responses)
fit.binomial <- glm(label~gradient+BFW.m+wood.m2, data=Nahmint, 
                    family=binomial(link=logit))
summary(fit.binomial)

# Note: for logistic regression, we need to check for overdispersion.
# This is because for a binary response, its theoretical variance is determined by its mean.
# But the observed variation may be different from the theoretical variance.
# We need to fit the above GLM to a quasibinomial to check if response y actually
# follows a Bernoulli distribution. 
# If the dispersion parameter is 1, then y follows Bernoulli distribution.
fit.binomial <- glm(label~gradient+BFW.m+wood.m2, data=Nahmint, 
                    family=quasibinomial(link=logit))
summary(fit.binomial) 
# Dispersion parameter for quasibinomial family is 0.9827053
# Thus, no over/underdispersion problem.


## 2. Part 2: gamma GLM with log link (only on positive responses)
fit.gamma <- glm(density.m2~gradient+BFW.m+wood.m2, data=subset(Nahmint, label==1), 
                 family=Gamma(link=log))
summary(fit.gamma)

# Note: no need to check for overdispersion for Gamma GLM because mean and variance
# for Gamma distribution are independent.



## 3. Prediction

## Prediction 1: on current dataset
prob.nonzero <- plogis(coef(fit.binomial)[[1]]) # P(Y_0 > 0 | X)
exp.gamma <- exp(coef(fit.gamma)[[1]]) # E(Y | Y_0 > 0, X)
pred <- prob.nonzero*exp.gamma # E(Y | X)

## Prediction 2: on new dataset
prob.nonzero <- predict(fit.binomail, data=new.dataframe, type="response")
exp.gamma <- predict(fit.gamma, data=new.dataframe, type="response")
pred <- prob.nonzero*exp.gamma

```
